<!DOCTYPE html>
<html lang="en">
<head>
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/timeline2.css" rel="stylesheet"/>
<link href="css/feeddata.css" rel="stylesheet"/>
<link href="css/movielist.css" rel="stylesheet"/>
<link href="css/author.css" rel="stylesheet"/>
</head>
<body>
<script src="js/jquery-latest.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/popcorn-complete.js"></script>
<script src="lib/socket.io/socket.io.js"></script>
<script>

var socket = null;
var json = null;
var userid = 0
var timeLinePopoverVisible = false;
//var username = "";
var loggedin = false;
var movieid = 0;
var popcorn = null;
var lastclicked = null;
var feeddata = null;
var timelineTitle = 0;
var currentTime = 0;
var serverLocation = 'http://linkontrol.toribash.com:1337';	
var streamId = "sid";

$(document).ajaxError(function(e, xhr, settings, exception) {
	console.log('error in: ' + settings.url + ' \\n'+'error:\\n' + exception);
});

var openUrl = function(url) {
	window.open(url, "_blank");
}

var setHeaderName = function(s) {
	console.log("setHeaderName" + s + " (" + streamId + ")");
	$("#headername").html(s);
}

var timeToSeconds = function(str) {
        var h = 0;
        var m = 0;
        var s = 0;
        var n = str.split(":");
        var l = n.length;
        if (l == 3) {
                h = parseInt(n[0], 10);
                m = parseInt(n[1], 10);
                s = parseInt(n[2], 10);
        }
        else if (l == 2) {
                m = parseInt(n[0], 10);
                s = parseInt(n[1], 10);
        }
        else if (l == 1) {
                s = parseInt(n[0], 10);
        }
        //console.log(str + "len" + l + "=> h:" + h + " m: " + m + " s:" + s);
        return (h * 360 + m * 60 + s);
}

var secondsToTime = function(s) {
	var h  = Math.floor(s / (60 * 60));
	s -= h * (60 * 60);
	var m  = Math.floor(s / 60);
        s -= m * 60;
	s = Math.floor(s);
	return { "h": h, "m": m, "s": s };
}

var padInt = function (x) {
	return String("0" + x).slice(-2);
}

var secondsToStr = function(seconds) {
	var t = secondsToTime(seconds);
	var h = padInt(t.h);
	var m = padInt(t.m);
	var s = padInt(t.s);
	return h + ":" + m + ":" + s;
}

var setAlert = function(message) {
	$('#apialert').html('<div class="alert"><a class="close" data-dismiss="alert">&times;</a><span>'+message+'</span></div>');
	$("#apialert").show();
}

var setRegisterAlert = function(message) {
	$('#registerAlert').html('<div class="alert"><a class="close" data-dismiss="alert">&times;</a><span>'+message+'</span></div>');
	$("#registerAlert").show();
}

var addQrCode = function(id) {
	console.log("addQrCode" + id);
	$("#qrcodediv").html(
			'<img id="qrcode" src="http://chart.apis.google.com/chart?chs=512x512&cht=qr&chld=L|0&chl=http%3A%2F%2Fwww.linkontrol.com%2Fremote.php%3Fid%3D' 
			+ id + '" alt="Get links in your mobile (' + id + ')">');  // widthHeight="64" widthHeight="64"/>');
	$("#qrcode").css("width", "64px");
}

var openMyMovies = function() {
	$("#viewmovie").fadeOut()
	$("#demomovies").fadeOut();
	if (popcorn) {
		popcorn.pause();
	}
	getUserMovies(0);
	setHeaderName("linklib.org");
}

var openMovie = function(id) {
	$("#movies").fadeOut();
	$("#demomovies").fadeOut();
	$("#viewmovie").fadeIn();
	fetchEvents(id);
}

var openDemoMovies = function() {
	$("#movies").fadeOut();
	$("#viewmovie").fadeOut();
	$("#demomovies").fadeIn();
}

var viewMovie = function(movieid) {
	var id = userid + "x" + movieid;
	var url = 'movie.html?id=' + id + '&movieid=' + movieid;
	console.log('open ' + url);
	window.open(url, 'movie', 
	'width=900,height=900,toolbar=yes,location=yes,directories=yes, status=yes,menubar=yes,scrollbar=yes,copyhistory=yes,resizable=yes,screenX=0');
}

var getPreviewData = function() {
	var linktype = $('[name=linktype]:checked').val(); 
	var img = $('[name=linkimage]:checked').val(); 
	var title = $('[name=title]').val(); 
	//var body = $('[name=body]').val(); 
	var url = $('[name=url]').val(); 
	var body = url;
	var time = $('[name=linkstart]').val(); 
	var start = timeToSeconds(time);
	var duration = popcorn.duration();
	var percent = (start / duration) * 100; 
	var feedid = $('[name=linkfeedid]').val();
	var index = $('[name=linkindex]').val();
	return { "linktype": linktype,
		"title": title,
		"body": body,
		"url": url,
		"deleted": 0,
		"img": img,
		"start": start,
		"percent": percent,
		"feedid": feedid,
		"index": index
	};
}

var printLinkPreview = function() {
	console.log(getPreviewData());
}

var getRegisterData = function() {
	var username = $('[name=registerUsername]').val(); 
	var password = $('[name=registerPassword]').val(); 
	var email = $('[name=registerEmail]').val(); 
	return { "username": username, "password": password, "email": email };
}

var updateLinkPreview = function() {
	/*
	var url = "a link";
	var type = $('[name=linktype]:checked').val(); 
	var img = 'Icons/' + $('[name=linkimage]:checked').val(); 
	var title = $('[name=title]').val(); 
	var body = $('[name=body]').val(); 
	var percent = 0;
	var start = 0;
	var feedid = 0;
	*/
	var d = getPreviewData();
	var h = feedToHtml(d.title, d.body, d.url, d.img, d.linktype, d.percent, d.start, d.feedid);
	$('#linkpreview').html(h);
}

var feedToHtml = function(title, body, url, img, type, percent, start, feedid) {
	var h = "";
        if (type == 5) { // text
                var h = '<div id="item' + feedid + '">' +
                        '<div id="itemText" start=' + start + '>' +
                                '<div id="icon"><img src="Icons/' + img + '" alt="twitter" width="55" height="55"/></div>' +
                                '<div id="itemContent">' +
                                        '<div id="itemTitle">' + title + '</div>' +
                                        '<div id="itemBody">' + body + '</div>' +
                                '</div>' +
                        '</div>' +
                        "</div>\n";
        }
        else {
                var h = '<div id="item' + feedid + '">' +
                        //'<div id="itemLink" onClick="openUrl(\'' + url + '\')" start=' + start + '>' +
                        '<div id="itemLink" start=' + start + '>' +
                                '<div id="icon"><img src="Icons/' + img + '" alt="twitter" width="55" height="55"/></div>' +
                                '<div id="itemContent">' +
                                        '<div id="itemTitle"> ' + title + '</div>' +
                                        '<div id="itemBody">' + body + '</div>' +
                                '</div>' +
                        '</div>' +
                        "</div>\n";
        }
	return h;
}

var addFeedData = function(title, body, url, img, type, percent, start, feedid) {
	//console.log("addFeedData");
        var h = "";
        if (type == 5) { // text
                var h = '<div id="item' + feedid + '">' +
                        '<div id="itemText" start=' + start + '>' +
                                '<div id="icon"><img src="Icons/' + img + '" alt="twitter" width="55" height="55"/></div>' +
                                '<div id="itemContent">' +
                                        '<div id="itemTitle">' + title + '</div>' +
                                        '<div id="itemBody">' + body + '</div>' +
                                '</div>' +
                        '</div>' +
                        "</div>\n";
        }
        else {
                var h = '<div id="item' + feedid + '">' +
                        '<div id="itemLink" onClick="openUrl(\'' + url + '\')" start=' + start + '>' +
                                '<div id="icon"><img src="Icons/' + img + '" alt="twitter" width="55" height="55"/></div>' +
                                '<div id="itemContent">' +
                                        '<div id="itemTitle"> ' + title + '</div>' +
                                        '<div id="itemBody">' + body + '</div>' +
                                '</div>' +
                        '</div>' +
                        "</div>\n";
        }
	
        $("#feeddata").append(h);
}

var handleFeed = function(currenttime) {
	var data = feeddata;
	var topItem = null;
	$.each(data.timefeed, function(i, item) {
		var x = document.getElementById('item' + item.feedid);
		//console.log(i + " " + item.feedid + " ct: " + currenttime + " start: " + item.start +  " " + x);
		if (x == null) {
			//console.log("cant find " + item.feedid);
		}
		else if (currenttime >= item.start) {
			//console.log("showing");
			//console.log(i + " " + item.feedid + " " + item.start);
			if (x.style.display == 'none') {
				$(x).fadeIn("slow");
				//$(x).animate({'opacity': show});
				topItem = item;
						
				//x.style.display = '';
			}
		}
		else {
			//console.log("hiding");
			x.style.display = 'none';
		}
	});
}

var clearFeed = function() {
	$("#feeddata").html("");
	$("#timeline").html("");
}

var hideFeeds = function() { 
        var data = feeddata;
        $.each(data.timefeed, function(i, item) {
                var x = document.getElementById('item' + item.feedid);
                if (x) {
                        x.style.display = 'none';
                }
        });
}

var enableLogin = function(_userid, username) {
	userid = _userid;
	if (userid) {
		$("#loginbar").hide();
		$("#logoutbar").show();
		$("#addLinkButton").show();
		$("#topusername").html(username);
		loggedin = true;
	}
	else {
		$("#loginbar").show();
		$("#logoutbar").hide();
		$("#addLinkButton").hide();
		$("#topusername").html("");
		loggedin = false;
	}
}

var updateFeeds = function() {
	clearFeed();
	var data = feeddata;
	var duration = popcorn.duration();
	$.each(data.timefeed, function(i, item) {
		var p = (item.start / duration) * 100;	
		console.log(i + " " + item.title + " " + item.start + " / " + duration);
		addTimeLineEvent(i, item.feedid, item.title, item.body, item.url, p); 
		addFeedData(item.title, item.body, item.url, item.img, item.linktype, p, item.start, item.feedid);
	});
	hideFeeds();
	addTooltip();
}

var loadMovie = function(url) {
	console.log("loadMovie " + url);
	// clear any old video stuff
	$("#video").html("");
	popcorn = Popcorn.smart('#video', url);
	popcorn.listen("error", function(e) {
		console.log("popcorn error " + e);
	});
	popcorn.listen("durationchange", function() {
		console.log("popcorn duration " + popcorn.duration());
		var duration = popcorn.duration();
		updateFeeds();
		/*
		clearFeed();
		var data = feeddata;
		$.each(data.timefeed, function(i, item) {
			var p = (item.start / duration) * 100;	
			//console.log(i + " " + item.title + " " + item.start + " / " + duration);
			addTimeLineEvent(i, item.feedid, item.title, item.body, item.url, p); 
			addFeedData(item.title, item.body, item.url, item.img, item.linktype, p, item.start, item.feedid);
		});
		hideFeeds();
		addTooltip();
		*/
	});
}

var deleteTimeFeed = function() {
	var d = getPreviewData();
	console.log(d);
	$.post('api.php?do=delete_time_feed', { 
			timefeedid: d.feedid
		}, function(data) { 
		console.log("msg: " + data.msg);
		if (data.error) {
			setAlert(data.msg);
		}
		else {
			console.log("update feed" + data);
			//removeTimeLineEvent(d.index);	
			//addTooltip();
			refreshEvents();
		}
	});
}

var updateTimeFeed = function() {
	var d = getPreviewData();
	console.log(d);
	$.post('api.php?do=update_time_feed', { 
			feedid: d.feedid, 
			start: d.start,
			end: 0,
			title: d.title,
			img: d.img,
			body: "",
			href: d.url
		}, function(data) { 
			console.log("msg: " + data.msg);
			if (data.error) {
				setAlert(data.msg);
			}
			else {
				/*
				console.log("update feed" + data);
				removeTimeLineEvent(d.index);	
				var f = feeddata.timefeed[d.index];
				f.start = d.start;
				f.img = d.img;
				f.url = d.url;	
				f.title = d.title;
				f.linktype = d.linktype;
				addTimeLineEvent(d.index, d.feedid, d.title, d.body, d.url, d.percent); 
				
				addTooltip();
				*/
				refreshEvents();
			}
	});
}

var hideTimeLinePopover = function() {
	timeLinePopoverVisible = false;
	$("#timelinebar").popover('hide');
}

var showTimeLinePopover = function() {
	timeLinePopoverVisible = true;
	$("#timelinebar").popover('show');
}

var createTimeFeed = function() {
	var text = $('[name=addlinktext]').val();
	hideTimeLinePopover();
	console.log("createTimeFeed text: " + text + " movieid: " + movieid + " currentTime:" + currentTime);
	$.post('api.php?do=create_time_feed&movieid=' + movieid, { text: text, start: currentTime }, function(data) { 
		if (data.error) {
			setAlert(data.msg);
		}
		else {
			/*
			var item = data.timefeed;
			console.log(item.title);
			var length = feeddata.timefeed.length;
			var duration = popcorn.duration();
			feeddata.timefeed[length] = data.timefeed;
			var p = (item.start / duration) * 100;	
			addTimeLineEvent(length, item.feedid, item.title, item.body, item.url, p); 
			addTooltip();
			*/
			refreshEvents();
		}
	}, "json")
	.success(function() { console.log("second success"); })
	.error(function(xhr, status, error) { console.log("error" + xhr.responseText + " status: " + status); })
	.complete(function() { console.log("complete"); });
}

// The higher NslowdownFactor the slower currentValue approaches targetValue
// typical values for slowdownFactor (2,4,10,20);
var weightedAverage = function(currentValue, targetValue, slowdownFactor) {
	return ((currentValue * (slowdownFactor - 1)) + targetValue) / slowdownFactor;
}

var addTooltip = function() {
	console.log("addToolTip");
        $("#timeline a").tooltip({
                animation: true,
                html: true,
                placement: "right",
                trigger: "hover",
                delay: { show: 1, hide: 100 }
        });

	$("#timeline a").click(function(e) {
		if (loggedin == false) {
			setAlert("Please sign in first");
			return;
		}	
		lastclicked = $(this);
		var idx = $(this).attr('idx');
		var data = feeddata.timefeed[idx];
		//console.log("feed event, click function" + $(this).attr('idx'));
		var h = feedToHtml(data.title, data.body, data.url, data.img, data.type, data.percent, data.start, data.feedid);
		console.log("linktype " + data.linktype);
		$('#linkpreview').html(h);
		$('[name=title]').val(data.title);
		$('[name=linkstart]').val(secondsToStr(data.start));
		$('[name=linkindex]').val(idx);
		$('[name=linkfeedid]').val(data.feedid);
		$('[name=url]').val(data.url);
		$('[name=linktype]')[data.linktype].checked = true;
		$('#linkimage1').attr('src', 'Icons/' + data.images[0]);	
		$('#linkimageradio1').val(data.images[0]);
		if (data.images[1] != "") {
			$('#linkimage2').attr('src', 'Icons/' + data.images[1]);		
			$('#linkimageradio2').val(data.images[1]);
		}
		$('#optionsRadio' + data.linktype).attr('checked', 'checked');

		console.log(data.images[0] + " " + data.images[1]);
		openEditFeed();
		e.stopPropagation();
	});

	$("#timeline").hover(
			function() {
				$("#timelinedisplay").fadeIn(100)
			},
			function() {
				$("#timelinedisplay").fadeOut(300)
			});

	var currentTimeLineX = 0;
	$("#timeline").mousemove(function(e) {
		//var posX = $(this).position().left;
		var posX = $(this).offset().left;
		var posY = $(this).position().top;
		//console.log(posX + " " + posY + " " + e.pageX);
		var offsetX = e.pageX - posX;
		var width = $(this).width();
		var duration = popcorn.duration();
		var normalized = (offsetX / width);
		var seconds = normalized * duration;
		currentTime = seconds;
		var t = secondsToTime(seconds);
		currentTimeLineX = weightedAverage(currentTimeLineX, offsetX, 10);
		$("#timelinedisplay").css("left", offsetX + "px");
		$("#timelinedisplay").html(secondsToStr(currentTime));
	});
}

var getUserMovies = function(userid) {
	console.log("getUserMovies" + userid);
	$.getJSON('api.php?do=get_user_movies&userid=' + userid, function(data) { 
		enableLogin(data.userid, data.username);
		clearMovies();
		$.each(data.movies, function(i, item) {
			console.log(item);
			addMovieImage(item.movieid, item.thumbnail, item.url, item.name); 
		});
	})
	.success(function() { console.log("second success"); })
	.error(function(xhr, status, error) { console.log("error" + xhr.responseText); })
	.complete(function() { 
		$("#movies").fadeIn();
	});
}

var refreshEvents = function() {
	console.log("refreshEvents for movie" + movieid);
	$.getJSON('api.php?do=movie_to_json&sort=desc&movieid=' + movieid, function(data) { 
		feeddata = data;
		updateFeeds();		
	})
	.success(function() { console.log("second success"); })
	.error(function(xhr, status, error) { console.log("error" + xhr.responseText); })
	.complete(function() { console.log("complete"); });
}

var fetchEvents = function(mid) {
	movieid = mid;
	
	console.log("fetching events for movie" + movieid);

	$.getJSON('api.php?do=movie_to_json&sort=desc&movieid=' + movieid, function(data) { 
		feeddata = data;
		console.log(data.movie);
		
		enableLogin(data.userid, data.username);
		if (data.movie && data.movie.name) {
			setHeaderName(data.movie.name);
		}
		streamId = data.movie.sessionid;
		clearFeed();
		loadMovie(data.movie.url);
		addQrCode(streamId);
		connect();
	})
	.success(function() { console.log("second success"); })
	.error(function(xhr, status, error) { console.log("error" + xhr.responseText); })
	.complete(function() { console.log("complete"); });
}

var addTimeLineEvent = function(idx, feedid, title, body, url, percent) {
	var t = body;
	if (title != "" && body != "") {
		t = title + "-" + body;;
	}
	else if (title != "") {
		t = title;
	}
	var h = '<a href="#" id="feed' + idx + '" idx="' + idx + '" feedid="' + feedid + '" rel="tooltip" title="' + t + '" class="feed-event" style="left: ' + percent + '%;"></a>';
	console.log(h);
	$("#timeline").append(h);
}


var addMovieImage = function(id, thumbnail, url, name) {
	var h = '<div id="movieImage" onClick="openMovie(' + id + ')">' + 
	//var h = '<div id="movieImage">' + 
		'<img src="' + thumbnail + '" class="movie" alt="Click to watch" />' +
		'<div id="movieText"> ' + name + '</div>' + 
		'<div id="movieTextLinks">' +
		//'<button class="btn btn-mini" type="button" onClick="viewMovie(' + id + ')">View</button></i>' +
		//'<button class="btn btn-mini" type="button" onClick="openMovie(' + id + ')">Edit</button></i>' +
		//'<i class="icon-play icon-white" onClick="viewMovie(' + id + ')"></i>' + 
		//'<i class="icon-edit icon-white" onClick="openMovie(' + id + ')"></i>' + 
		'</div>' + 
		'</div>';
	//console.log(thumbnail);
	$("#movies").append(h);
}

var removeTimeLineEvent = function(idx) {
	feeddata.timefeed[idx].deleted = 1;
	$("#feed" + idx).remove();
}

var addFeedEvent = function(title, url, percent) {
	var h = "<a title='" + title + " - " + url + "' class='feed-event' style='left: " + percent + "%;'></a>";
	//console.log(h);
	$("#feeddata").append(h);
}

var addLinkFlowEvent = function(title, body, url, img, type, percent, start, feedid) {
        var h = "";
        if (type == 5) { // text
                var h = '<div id="item' + feedid + '">' +
                        '<div id="itemText" start=' + start + '>' +
                                '<div id="icon"><img src="' + img + '" alt="twitter" width="55" height="55"/></div>' +
                                '<div id="itemContent">' +
                                        '<div id="itemTitle">' + title + '</div>' +
                                        '<div id="itemBody">' + body + '</div>' +
                                '</div>' +
                        '</div>' +
                        "</div>\n";
        }
        else {
                var h = '<div id="item' + feedid + '">' +
                        '<div id="itemLink" onClick="openUrl(\'' + url + '\')" start=' + start + '>' +
                                '<div id="icon"><img src="' + img + '" alt="twitter" width="55" height="55"/></div>' +
                                '<div id="itemContent">' +
                                        '<div id="itemTitle"> ' + title + '</div>' +
                                        '<div id="itemBody">' + body + '</div>' +
                                '</div>' +
                        '</div>' +
                        "</div>\n";
        }
        $("#feeddata").append(h);
}


var clearFeed = function() {
	$("#timeline").html("");
	$("#feeddata").html("");
}

var clearMovies = function() {
	$("#movies").html("");
}

var hidePopover2 = function() {
	console.log("from input type");
}

var logout = function() {
	console.log("logout");
	$.getJSON('api.php?do=logout&movieid=' + movieid, function(data) { 
		enableLogin(data.userid, "");
		clearMovies();
		openDemoMovies();
	})
	.success(function() { console.log("second success"); })
	.error(function(xhr, status, error) { console.log("error" + xhr.responseText); })
	.complete(function() { console.log("complete"); });
}

var login = function(username, password) {
	$.post('api.php?do=login',{ "username": username, "password": password },
		function(data) {
			if (data.error) {
				setAlert(data.alert + " " + data.msg);
			}
			enableLogin(data.userid, data.username);
			openMyMovies();
		}, 'json');
}

var addMovie = function(url, name) {
	$.post('api.php?do=add_movie', { "url": url, "href": url, "name": name},
		function(data) {
			console.log(data);
			if (data.error) {
				setAlert(data.alert + " " + data.msg);
			}
			else {
				movieid = data.movie.movieid;
				fetchEvents(movieid);
				getUserMovies(0);
			}
		}, 'json');
}

var onAddMovie = function() {
	var url = $("#addMovieUrl").val();
	var name = $("#addMovieName").val();
	addMovie(url, name);
	$("#addMovieModal").modal('hide')
}

var register = function() {
	console.log("register");
	var r = getRegisterData();

	$.post('api.php?do=register', { 
		"username": r.username,
		"email": r.email,
		"password": r.password }, function(data) {
		console.log(data);
		if (data.error) {
			setRegisterAlert(data.alert + " " + data.msg);
		}
		else {
			$("#registerModal").modal('hide')
			login(r.username, r.password);
		}
	}, 'json');
	//.success(function() { console.log("second success"); })
	//.error(function(xhr, status, error) { console.log("error" + xhr.responseText); })
	//.complete(function() { console.log("complete"); });
}


function getParams() {
        var idx = document.URL.indexOf('?');
        if (idx != -1) {
                var tempParams = new Object();
                var pairs = document.URL.substring(idx+1, document.URL.length).split('&');
                for (var i=0; i< pairs.length; i++) {
                        nameVal = pairs[i].split('=');
                        tempParams[nameVal[0]] = nameVal[1];
                }
                return tempParams;
        }
}

var openEditFeed = function() {
	$("#editModal").modal('show');
	$("#linktitle").focus();
}

var openRegister = function() {
	$("#registerModal").modal('show');
}

var openAddMovie = function() {
	$("#addMovieModal").modal('show');
}

var getTimelineTitle = function() {
	return timelineTitle;
}

var handleGetTime = function(data) {
	data.time = popcorn.currentTime();
	emit("time", data);
}

function emit(command, data) {
	console.log("emit" + data);
	if (!data) {
		data = {};
	}
	data.streamId = streamId;
	socket.emit(command, data);
}

var connect = function() {
	console.log("connecting to " + serverLocation + " streamid:" + streamId);
	socket = io.connect(serverLocation);
	socket.emit("join", {'streamId':streamId});
	socket.on('getTime', handleGetTime);
}

$(function() {
	enableLogin(0, "");
	openDemoMovies();

        params = getParams();
        if (params && params["movieid"]) {
                movieid = params["movieid"];
		fetchEvents(movieid);
        }

        var onTooltipUpdate = function(tooltip, x, y) {
                console.log(tooltip);
                //console.log("yey" + x + " " + y);
        }       
	// Setup drop down menu
	$('.dropdown-toggle').dropdown();
 
  	// Fix input element click problem
	$('.dropdown input, .dropdown label').click(function(e) {
		e.stopPropagation();
	});

	$('form[name=previewform]').change(function() {
		var linktype = $('[name=linktype]:checked').val();
		var img = $('[name=linkimage]:checked').val();
		//console.log("linktype: " + linktype + " img: " + img);
		//console.log("here" + $('[name=linktype]:checked').val());
		updateLinkPreview();
	});

	$('form[name=loginform]').submit(function() {
		console.log("loginform submit");
		console.log("username" + $('[name=username]').val());
		login($('[name=username]').val(), $('[name=password]').val());
		/*
		$.post('api.php?do=login',{
			username: $('[name=username]').val(), 
			password: $('[name=password]').val() }, 
			function(data) {
				if (data.error) {
					setAlert(data.alert + " " + data.msg);
				}
				console.log(data.alert + " " + data.msg);
				enableLogin(data.userid, data.username);
			}, 'json');
		*/
		return false;
	});

        $('form[name=addmovieform]').submit(function() {
                console.log("movieform submit");
		//$("#addmoviemenu").hide();
                addMovie($('[name=addmovieurl]').val(), "something");
                return false;
        });

        $("#timeline a").tooltip({
                track: true,
                delay: 0,
                showURL: false,
                fixPNG: false,
                showBody: " - ",
                extraClass: "pretty fancy",
                top: -15,
                onUpdate: onTooltipUpdate,
                left: 5
        });

	$(".container").click(function(e) {
		hideTimeLinePopover();	
	});

	$("#timeline").click(function(e) {
		if (loggedin == false) {
			console.log("Please sign in first");
			return;
		}	
		//var posX = $(this).position().left;
		var posX = $(this).offset().left;
		var posY = $(this).position().top;
		var offsetX = e.pageX - posX;
		var width = $(this).width();
		var duration = popcorn.duration();
		if (duration == 0) {
			console.log("move doesnt have duration yet");
			return;
		}
		var normalized = (offsetX / width);
		var seconds = normalized * duration;
		currentTime = seconds;
		var t = secondsToTime(seconds);
		$("#timelinebar").css("left", offsetX + "px");
		if (t.h > 0) {
			timelineTitle = t.h + "h" + t.m + "m" + t.s + "s";
		}
		else if (t.m > 0) {
			timelineTitle = t.m + "m" + t.s + "s";
		}
		else {
			timelineTitle = t.s + "s";
		}
		e.stopPropagation();
		showTimeLinePopover();
		$("#addlink").focus();
	});

	$("#timelinebar").popover({placement: "bottom", live:true, 
			title: getTimelineTitle, 
			content: '<input name="addlinktext" id="addlink" type="text" placeholder="paste link or type comment" onSubmit="hidePopover2(); return false;"/><button class="btn" onclick="createTimeFeed();">Save</button>', 
			html:true
	});

	$("#timelinebarnow").popover({placement: "bottom", live:true, 
			title: getTimelineTitle, 
			content: '<input name="addlinktext" id="addlink" type="text" placeholder="paste link or type comment" onSubmit="hidePopover2(); return false;"/><button class="btn" onclick="createTimeFeed();">Save</button>', 
			html:true
	});

	$("#addLinkButton").click(function(e) {
		if (popcorn == null) {
			return;
                }
		if (loggedin == false) {
			console.log("Please sign in first");
			return;
		}
		if (popcorn.duration() == 0) {
			return;
		}
		popcorn.pause();
		timelineTitle = secondsToStr(popcorn.currentTime());
		var percent = (popcorn.currentTime() / popcorn.duration()) * 100;
		$("#timelinebar").css("left", percent + "%");
		//$("#timelinebar").popover('show');
		showTimeLinePopover();
		$("#addlink").focus();
		e.stopPropagation();
	});

        setInterval(function () {
		if (popcorn == null) {
			return;
		}
		if (popcorn.duration() == 0) {
			return;
		}
		var currentButtonTime = popcorn.currentTime();
		var s = secondsToStr(currentButtonTime);
		$("#addLinkButton").html("Add Link at " + s);
		timelineTitle = secondsToStr(popcorn.currentTime());

		if (timeLinePopoverVisible == false) {
			var percent = (popcorn.currentTime() / popcorn.duration()) * 100;
			$("#timelinebar").css("left", percent + "%");
		}

		if (socket) {
                	var data = {};
                	if (!data.time) {
                        	data.time = popcorn.currentTime();
                	}
                	if (popcorn.paused()) {
                        	emit("onPause", data);
                	}
                	else {
                        	emit("onPlay", data);
                	}
		}
		handleFeed(popcorn.currentTime());
        }, 700);

	$("#qrcodediv").click(function(e) {
		if ($("#qrcode").css("width") == "64px") {
			$("#qrcode").animate({
				height: "512",
				width: "512"
			}, "fast");
		}
		else {
			$("#qrcode").animate({
				height: "64",
				width: "64"
			}, "fast");
		}
	});
});

</script>

	<div class="navbar navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container">
				<!--
				<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</a>
				-->
 
				<a class="brand" id="headername">linklib.org</a>

				<div class="nav-collapse">
					<ul class="nav pull-right" id="loginbar">
						<li><a href="#" onClick="openRegister()">Sign Up</a></li>
						<li class="divider-vertical"></li>
						<li class="dropdown">
							<a class="dropdown-toggle" href="#" data-toggle="dropdown">Sign In <strong class="caret"></strong></a>
							<div class="dropdown-menu" style="padding: 15px; padding-bottom: 0px;">
								<form action="" method="post" accept-charset="UTF-8" name="loginform">
									<input id="username" style="margin-bottom: 15px;" type="text" name="username" size="30" placeholder="Username" />
									<input id="password" style="margin-bottom: 15px;" type="password" name="password" size="30" placeholder="Password" />
									<input class="btn btn-primary" style="clear: left; width: 100%; height: 32px; font-size: 13px;" type="submit" name="commit" value="Sign In" />
								</form>
							</div>
						</li>
					</ul>
					<ul class="nav pull-right" id="logoutbar">
						<li id="topusername" class="brand">username</li>
						<li class="divider-vertical"></li>
						<li><button class="btn" onclick="openAddMovie();">Add Movie</button></li>
						<li class="divider-vertical"></li>
						<li><button class="btn" onclick="openMyMovies();">My Movies</button></li>
						<li class="divider-vertical"></li>
						<li><button class="btn" onclick="logout();">Logout</button></li>
					</ul>
				</div>
			</div>
		</div>
	</div>


	<!-- <div class="container" style="height:800px;background-color:#00ff00;width:100%;height:1000px"> -->
	<div class="container" style="position:absolute; left:0; width:100%; height:800px;background-color:#ffFFff">
		<div id="apialert"></div>
		<div id="viewmovie" style="display:none">
			<div id="videodiv" class="videodiv" style="position:relative; margin: 43px 310px 10px 0px;background-color:#000000;min-height:600px">
				<div id="qrcodediv" style="position:absolute;width:100%; text-align:right"></div>
				<div id="video" style="height:600px;width:100%"></div>
			
				<div id="timelinecontainer" style="position:relative; width:70%; margin-left:auto; margin-right:auto;margin-top:10px">
					<div id="timeline"></div>
					<div id="timelinebar" style="position:absolute; height:20px;left:100px;width:10px;background-color:#fff0ff; opacity:0.1;"></div>
					<div id="timelinedisplay" style="position:absolute; height:20px;top:20px;left:100px;width:100px;background-color:#ffffff;">11:11:22</div>
				</div>
				<div class="row" style="position:relative; top:40px; left:50px">
						<button class="btn btn-small" type="button" id="addLinkButton">Add link at 00:00:00</button>
				</div>
			</div>
			<div id="feeddata" style="position:absolute;top:43px;width:300px;height:100%;right:0px;background-color:#000000"></div>
		</div>
		<div id="movies" style="display: 'none'">
			<!-- filled by javascript -->
		</div>
		<div id="demomovies">
			<div id="movieImage" onClick="openMovie(13)">
				<img src="img/460/thebig.png" class="movie" alt="Click to watch" />
				<div id="movieText"> The Big Lebowski (Coen, 1998) </div>					
			</div>
			<div id="movieImage" onClick="openMovie(24)">
				<img src="img/460/black.png" class="movie" alt="Click to watch" />
				<div id="movieText"> The Black Keys - Tighten Up </div>
			</div>
			<div id="movieImage" onClick="openMovie(46)">
				<img src="img/460/armadillo.png" class="movie" alt="Click to watch" />
				<div id="movieText"> Armadillo (Metz, 2010) </div>
			</div>
			<div id="movieImage" onClick="openMovie(55)">
				<img src="img/460/merkely.png" class="movie" alt="Click to watch" />
				<div id="movieText"> TED Talk Popcorn (Merkely, 2012) </div>					
			</div>
			<div id="movieImage" onClick="openMovie(16)">
				<img src="img/460/madmen.png" class="movie" alt="Click to watch" />
				<div id="movieText"> Mad Men S04E20 (Weiner, 2011) </div>					
			</div>
			<div id="movieImage" onClick="openMovie(18)">
				<img src="img/460/top100.png" class="movie" alt="Click to watch" />
				<div id="movieText"> 100 Greatest Hits of YouTube </div>
			</div>
			<div id="movieImage" onClick="openMovie(50)">
				<img src="img/460/indiegamethemovie2.png" class="movie" alt="Click to watch" />
				<div id="movieText"> Indie Game: The Movie (Pajot & Swirsky, 2012)</div>					
			</div>
			<div id="movieImage" onClick="openMovie(44)">
				<img src="img/460/mammasgata.png" class="movie" alt="" />
				<div id="movieText"> Promoe feat Timbuktu "Mamma's Gata" (2009) </div>
			</div>
			<div id="movieImage" onClick="openMovie(53)">
				<img src="img/460/businesscanvas.png" class="movie" alt="" />
				<div id="movieText"> Business Model Generation (Osterwalder, 2011)</div>
			</div>
			<div id="movieImage" onClick="openMovie(54)">
				<img src="img/460/bigbird.png" class="movie" alt="" />
				<div id="movieText"> Big Bird Presidential debate 2012 </div>
			</div>
			<div id="movieImage" onClick="openMovie(68)">
				<img src="img/460/palme.png" class="movie" alt="" />
				<div id="movieText"> Palme Official Trailer </div>
			</div>
			<div id="movieImage" onClick="openMovie(70)">
				<img src="img/460/whysendlinkstophones.png" class="movie" alt="" />
				<div id="movieText"> Why send links to phones</div>
			</div>
			<!--
			<div id="movieImage" onClick="openMovie(1)">
				<img src="img/460/tpbafk.png" class="movie" alt="Click to watch" />
				<div id="movieText"> TPB AFK (Klose, 2013) </div>					
			</div>
			-->
		</div>
	</div>

	<div id="editModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			<h3 id="editModalLabel">Edit Feed</h3>
		</div>
		<div class="modal-body">
			<p>Link preview</p>
			<p>
			<div id="linkpreview">
                        	<div id="itemText">
                                	<div id="icon">
						<img src="Icons/twitter.svg" alt="twitter" width="55" height="55"/>
					</div>
                                	<div id="itemContent">
                                       		<div id="itemTitle">Title</div>
						<div id="itemBody">body</div>
					</div>
                        	</div>
			</div>
			</p>
			<form name="previewform">
				<input type="hidden" name="linkfeedid" value="123">
				<input type="hidden" name="linkindex" value="123">
				<label class="control-label" for="linktitle">Title
					<input class="input-xlarge" name="title" id="linktitle" type="text" value="title"><span class="help-inline">title</span>
				</label>
				<label class="control-label" for="linkurl">Url
					<input class="input-xlarge" name="url" id="linkurl" type="text" value="url"><span class="help-inline">url</span>
				</label>
				<label class="control-label" for="linkstart">HH:MM:SS
					<input class="input-small" name="linkstart" id="linkstart" type="text" value="0">
				</label>
				<p>Link Type</p>
				<label class="radio">
					<input type="radio" name="linktype" id="optionsRadios0" value="0" checked> Web Page
				</label>
				<label class="radio">
					<input type="radio" name="linktype" id="optionsRadios5" value="5"> Text 
				</label>
				<label class="radio">
					<input type="radio" name="linktype" id="optionsRadios3" value="3"> Video 
				</label>
			<p>Choose Image</p>
			<label class="radio inline">
				<input type="radio" name="linkimage" id="linkimageradio1" value="twitter.svg" checked> 
					<img id="linkimage1" src="Icons/twitter.svg" width="55" height="55" style="background-color:#000" /> 
			</label>
			<label class="radio inline">
				<input type="radio" name="linkimage" id="linkimageradio2" value="facebook.svg">
					<img id="linkimage2" src="Icons/facebook.svg" width="55" height="55" style="background-color:#000" /> 
			</label>
			</form>
			<!--
    			<div class="btn-group">
    				<button class="btn">1</button>
				<button class="btn">2</button>
				<button class="btn">3</button>
			</div>
			-->
		</div>
		<div class="modal-footer">
			<button class="btn pull-left" data-dismiss="modal" onClick="deleteTimeFeed()">Delete</button>
			<button class="btn" data-dismiss="modal">Close</button>
			<button class="btn btn-primary" data-dismiss="modal" onClick="updateTimeFeed()">Save changes</button>
		</div>
	</div>

         <div id="myPopover" class="popover bottom">
            <div class="arrow"></div>
            <h3 class="popover-title">Popover bottom</h3>
            <div class="popover-content">
              <p>Sed posuere consectetur est at lobortis. Aenean eu leo quam. Pellentesque ornare sem lacinia quam venenatis vestibulum.</p>
            </div>
          </div>

	<!-- register -->
	<div id="registerModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			<h3 id="editModalLabel">Register</h3>
		</div>
		<div class="modal-body">
    			<div id="registerAlert"></div>
			<form class="form-horizontal">
				<div class="control-group">
					<label class="control-label" for="inputUsername">Username</label>
					<div class="controls">
						<input name="registerUsername" type="text" id="inputUsername" placeholder="Username">
					</div>
				</div>
				<div class="control-group">
					<label class="control-label" for="inputEmail">Email</label>
					<div class="controls">
						<input name="registerEmail" type="text" id="inputEmail" placeholder="Email">
					</div>
				</div>
				<div class="control-group">
					<label class="control-label" for="inputPassword">Password</label>
					<div class="controls">
						<input name="registerPassword" type="password" id="inputPassword" placeholder="Password">
					</div>
				</div>
			</form>
		</div>
		<div class="modal-footer">
			<button class="btn" data-dismiss="modal">Close</button>
			<button class="btn btn-primary" onClick="register()">Register</button>
		</div>
	</div>

	<!-- add movie -->
	<div id="addMovieModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			<h3 id="editModalLabel">Add Movie</h3>
		</div>
		<div class="modal-body">
    			<div id="addMovieAlert"></div>
			<form class="form-horizontal">
				<div class="control-group">
					<label class="control-label" for="addMovieUrl">Url</label>
					<div class="controls">
						<input name="addMovieUrl" type="text" id="addMovieUrl" placeholder="vimeo or youtube link">
					</div>
				</div>
				<div class="control-group">
					<label class="control-label" for="inputEmail">Name</label>
					<div class="controls">
						<input name="addMovieName" type="text" id="addMovieName" placeholder="Name">
					</div>
				</div>
			</form>
		</div>
		<div class="modal-footer">
			<button class="btn" data-dismiss="modal">Close</button>
			<button class="btn btn-primary" onClick="onAddMovie()">Add Movie</button>
		</div>
	</div>
</body>
</html>
