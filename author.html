<!DOCTYPE html>
<html lang="en">
<head>
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/timeline.css" rel="stylesheet"/>
</head>
<body>
<!--
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script src="http://popcornjs.org/code/dist/popcorn-complete.js"></script>
<script src="lib/jquery/jquery.bgiframe.js" type="text/javascript"></script>
<script src="lib/jquery/jquery.dimensions.js" type="text/javascript"></script>
<script src="lib/jquery/jquery.tooltip.js" type="text/javascript"></script>
-->
<script src="http://code.jquery.com/jquery-latest.js"></script>
<script src="js/bootstrap.min.js"></script>
<script>

var json;
var userid = 0
var username = "";
var movieid = 0;

$(document).ajaxError(function(e, xhr, settings, exception) {
	console.log('error in: ' + settings.url + ' \\n'+'error:\\n' + exception);
});

var setAlert = function(message) {
	$('#apialert').html('<div class="alert"><a class="close" data-dismiss="alert">x</a><span>'+message+'</span></div>');
	$("#apialert").show();
}

var enableLogin = function(on) {
	if (on) {
		$("#loginbar").hide();
		$("#logoutbar").show();
	}
	else {
		$("#loginbar").show();
		$("#logoutbar").hide();
	}
}

var hidePopover = function(x) {
	console.log("do it2" + x);
	$("#kuk").popover('hide');
	$.post('api.php?do=add_time_feed&movieid=' + movieid, { title: $('[name=url]').val() }, function(data) { 
		myData = data;
		console.log(data.alert + " " + data.userid + " " + data.username + " " + data.timefeed.title);
		//if (data.alert == "error") {
			setAlert(data.msg);
		//}
		//addFeedEvent("a title", "http://www.wut.com", Math.floor((Math.random() * 100) + 1));
  		//$('.result').html(data);
	}, "json")
	.success(function() { console.log("second success"); })
	.error(function(xhr, status, error) { console.log("error" + xhr.responseText + " status: " + status); })
	.complete(function() { console.log("complete"); });

}

var myData;
var fetchEvents = function(movieid) {
	console.log("fetching events for movie" + movieid);
	$.getJSON('api.php?abc=xxx&do=movie_to_json&movieid=' + movieid, function(data) { 
		//addFeedEvent("a title", "http://www.wut.com", Math.floor((Math.random() * 100) + 1));
		myData = data;
		console.log(data.movie.name + " " + data.userid + " " + data.username);
		$("#topusername").html(data.username);
		enableLogin(data.userid);
		if (data.movie && data.movie.name) {
			$("#moviename").html(data.movie.name);
		}
		//console.log(data[0]);
		clearFeed();
		$.each(data.timefeed, function(i, item) {
			//console.log(i + " " + item.title);
			addFeedEvent(item.title, item.body, item.percent);
		});
	})
	.success(function() { console.log("second success"); })
	.error(function(xhr, status, error) { console.log("error" + xhr.responseText); })
	.complete(function() { console.log("complete"); });
}

var addFeedEvent = function(title, url, percent) {
	var h = "<a title='" + title + " - " + url + "' class='feed-event' style='left: " + percent + "%;'></a>";
	//console.log(h);
	$("#feeddata").append(h);
}

var clearFeed = function() {
	console.log("clearFeed");
	$("#feeddata").html("");
}

var hidePopover2 = function() {
	console.log("from input type");
	//$("#kuk").popover('hide');
}

function getParams() {
        var idx = document.URL.indexOf('?');
        if (idx != -1) {
                var tempParams = new Object();
                var pairs = document.URL.substring(idx+1, document.URL.length).split('&');
                for (var i=0; i< pairs.length; i++) {
                        nameVal = pairs[i].split('=');
                        tempParams[nameVal[0]] = nameVal[1];
                }
                return tempParams;
        }
}

$(function() {
        params = getParams();
        if (params && params["movieid"]) {
                movieid = params["movieid"];
		fetchEvents(movieid);
        }

        var onTooltipUpdate = function(tooltip, x, y) {
                console.log(tooltip);
                //console.log("yey" + x + " " + y);
        }       
	// Setup drop down menu
	$('.dropdown-toggle').dropdown();
 
  	// Fix input element click problem
	$('.dropdown input, .dropdown label').click(function(e) {
		e.stopPropagation();
	});

	$('form[name=loginform]').submit(function() {
		console.log("loginform submit");
		console.log("username" + $('[name=username]').val());
		$.post('api.php?do=login',{
			username: $('[name=username]').val(), 
			password: $('[name=password]').val() }, 
			function(data) {
				setAlert(data.alert + " " + data.msg);
				console.log(data.alert + " " + data.msg);
				/*
				if (data.success) {
					console.log("success");
				}
				else {
					console.log("fail");
				}
				*/
			}, 'json');
		return false;
	});

        $("#timeline a").tooltip({
                track: true,
                delay: 0,
                showURL: false,
                fixPNG: false,
                showBody: " - ",
                extraClass: "pretty fancy",
                top: -15,
                onUpdate: onTooltipUpdate,
                left: 5
        });
	$("#timeline").click(function(e) {
		var posX = $(this).position().left;
		var posY = $(this).position().top;
		var offsetX = e.pageX - posX;
		//console.log("click" + e.pageX+ ' , ' + e.pageY);
		//console.log("click" + posX + ' , ' + posY);
		//console.log( (e.pageX - posX) + ' , ' + (e.pageY - posY));
		//$("#myModal").modal('toggle');
		//$('#myPopover').popover('show')
		$("#kuk").css("left", offsetX + "px");
		$("#kuk").popover('show');
		$("#addlink").focus();
	});

	$("#kuk").popover({placement: "bottom", live:true, 
			title: '5m32s', 
			//content: '<form><input id="addlink" type="text" placeholder="paste link or type comment" onSubmit="hidePopover2(); return false;"/><button class="btn" onclick="hidePopover(44);">Save</button></form>', 
			content: '<input name="url" id="addlink" type="text" placeholder="paste link or type comment" onSubmit="hidePopover2(); return false;"/><button class="btn" onclick="hidePopover(44);">Save</button>', 
			html:true
	});
	
});
</script>

	<div class="navbar navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container">
				<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</a>
 
				<a class="brand" id="moviename">linklib.org</a>

				<div class="nav-collapse">
					<ul class="nav pull-right" id="loginbar">
						<li><a href="/users/sign_up">Sign Up</a></li>
						<li class="divider-vertical"></li>
						<li class="dropdown">
							<a class="dropdown-toggle" href="#" data-toggle="dropdown">Sign In <strong class="caret"></strong></a>
							<div class="dropdown-menu" style="padding: 15px; padding-bottom: 0px;">
								<form action="" method="post" accept-charset="UTF-8" name="loginform">
								<input id="username" style="margin-bottom: 15px;" type="text" name="username" size="30" />
								<input id="password" style="margin-bottom: 15px;" type="password" name="password" size="30" />
								<input class="btn btn-primary" style="clear: left; width: 100%; height: 32px; font-size: 13px;" type="submit" name="commit" value="Sign In" />
								</form>
							</div>
						</li>
					</ul>
					<ul class="nav pull-right" id="logoutbar">
						<li id="topusername">username</li>
						<li class="divider-vertical"></li>
						<li><button class="btn" onclick="logout();">Logout</button></li>
					</ul>
				</div>
			</div>
		</div>
	</div>

	<div class="container" style="height:800px;background-color:#ff00ff">
		<!-- <button class="btn" onclick="hidePopover(44);">Save</button> -->
		<!--
    		<div class="alert" id="apialert">
    			<button type="button" class="close" data-dismiss="alert"></button>
    			<strong>Warning!</strong> Best check yo self, you're not looking too good.
    		</div>
		-->
		<div id="videodiv" class="videodiv">
			<div id="youtube" style="padding-top:50px;width:640px;height:480px;background-color:#00ff00"></div>
			<div id="timeline">
				<div id="feeddata">
					<a title='Wikipedia US Presidential Election, 2008 - http://en.wikipedia.org/wiki/United_States_presidential_election,_2008' class='feed-event' style='left: 10%;'></a>
					<a title='Wikipedia Homer Simpsons - http://en.wikipedia.org/wiki/Homer_Simpson' class='feed-event' style='left: 50%;'></a>
				</div>
				<div id="kuk" style="position:absolute; height:100px;left:100px;width:10px;background-color:#ff0000"></div>
			</div>
		</div>
		<div id="apialert"></div>
	</div>

          <!-- sample modal content -->
          <div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
              <h3 id="myModalLabel">Modal Heading</h3>
            </div>
            <div class="modal-body">
              <h4>Text in a modal</h4>
              <p>Duis mollis, est non commodo luctus, nisi erat porttitor ligula, eget lacinia odio sem.</p>

              <h4>Popover in a modal</h4>
              <p>This <a href="#" role="button" class="btn popover-test" title="A Title" data-content="And here's some amazing content. It's very engaging. right?">button</a> should trigger a popover on hover.</p>

              <h4>Tooltips in a modal</h4>
              <p><a href="#" class="tooltip-test" title="Tooltip">This link</a> and <a href="#" class="tooltip-test" title="Tooltip">that link</a> should have tooltips on hover.</p>

              <hr>

              <h4>Overflowing text to show optional scrollbar</h4>
              <p>We set a fixed <code>max-height</code> on the <code>.modal-body</code>. Watch it overflow with all this extra lorem ipsum text we've included.</p>
              <p>Cras mattis consectetur purus sit amet fermentum. Cras justo odio, dapibus ac facilisis in, egestas eget quam. Morbi leo risus, porta ac consectetur ac, vestibulum at eros.</p>
              <p>Praesent commodo cursus magna, vel scelerisque nisl consectetur et. Vivamus sagittis lacus vel augue laoreet rutrum faucibus dolor auctor.</p>
              <p>Aenean lacinia bibendum nulla sed consectetur. Praesent commodo cursus magna, vel scelerisque nisl consectetur et. Donec sed odio dui. Donec ullamcorper nulla non metus auctor fringilla.</p>
              <p>Cras mattis consectetur purus sit amet fermentum. Cras justo odio, dapibus ac facilisis in, egestas eget quam. Morbi leo risus, porta ac consectetur ac, vestibulum at eros.</p>
              <p>Praesent commodo cursus magna, vel scelerisque nisl consectetur et. Vivamus sagittis lacus vel augue laoreet rutrum faucibus dolor auctor.</p>
              <p>Aenean lacinia bibendum nulla sed consectetur. Praesent commodo cursus magna, vel scelerisque nisl consectetur et. Donec sed odio dui. Donec ullamcorper nulla non metus auctor fringilla.</p>
            </div>
            <div class="modal-footer">
              <button class="btn" data-dismiss="modal">Close</button>
              <button class="btn btn-primary">Save changes</button>
            </div>
          </div>

         <div id="myPopover" class="popover bottom">
            <div class="arrow"></div>
            <h3 class="popover-title">Popover bottom</h3>
            <div class="popover-content">
              <p>Sed posuere consectetur est at lobortis. Aenean eu leo quam. Pellentesque ornare sem lacinia quam venenatis vestibulum.</p>
            </div>
          </div>


	<a href="#" id="element2" rel="popover" title="A Title" data-content="And here's some amazing content. It's very engaging. right?">Yo</a>
		<!--
		<div class="bs-docs-example" style="padding-bottom: 24px;">
			<a href="#" id="element2" class="btn btn-large btn-danger" rel="popover" title="A Title" data-content="And here's some amazing content. It's very engaging. right?">Click to toggle popover</a>
		</div>
	-->
</body>
</html>
