<!DOCTYPE html>
<html lang="en">
<head>
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/timeline2.css" rel="stylesheet"/>
<link href="css/feeddata.css" rel="stylesheet"/>
</head>
<body>
<script src="http://code.jquery.com/jquery-latest.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="http://popcornjs.org/code/dist/popcorn-complete.js"></script>
<script>

var json;
//var userid = 0
//var username = "";
var loggedin = false;
var movieid = 0;
var popcorn;
var lastclicked = null;
var feeddata = null;
var timelineTitle = 0;
var currentTime = 0;

$(document).ajaxError(function(e, xhr, settings, exception) {
	console.log('error in: ' + settings.url + ' \\n'+'error:\\n' + exception);
});

var timeToSeconds = function(str) {
        var h = 0;
        var m = 0;
        var s = 0;
        var n = str.split(":");
        var l = n.length;
        if (l == 3) {
                h = parseInt(n[0], 10);
                m = parseInt(n[1], 10);
                s = parseInt(n[2], 10);
        }
        else if (l == 2) {
                m = parseInt(n[0], 10);
                s = parseInt(n[1], 10);
        }
        else if (l == 1) {
                s = parseInt(n[0], 10);
        }
        //console.log(str + "len" + l + "=> h:" + h + " m: " + m + " s:" + s);
        return (h * 360 + m * 60 + s);
}

var secondsToTime = function(s) {
	var h  = Math.floor(s / (60 * 60));
	s -= h * (60 * 60);
	var m  = Math.floor(s / 60);
        s -= m * 60;
	s = Math.floor(s);
	return { "h": h, "m": m, "s": s };
}

var padInt = function (x) {
	return String("0" + x).slice(-2);
}

var secondsToStr = function(seconds) {
	var t = secondsToTime(seconds);
	var h = padInt(t.h);
	var m = padInt(t.m);
	var s = padInt(t.s);
	return h + ":" + m + ":" + s;
}

var setAlert = function(message) {
	$('#apialert').html('<div class="alert"><a class="close" data-dismiss="alert">x</a><span>'+message+'</span></div>');
	$("#apialert").show();
}

var getPreviewData = function() {
	var linktype = $('[name=linktype]:checked').val(); 
	var img = $('[name=linkimage]:checked').val(); 
	var title = $('[name=title]').val(); 
	//var body = $('[name=body]').val(); 
	var url = $('[name=url]').val(); 
	var body = url;
	var time = $('[name=linkstart]').val(); 
	var start = timeToSeconds(time);
	var duration = popcorn.duration();
	var percent = (start / duration) * 100; 
	var feedid = $('[name=linkfeedid]').val();
	var index = $('[name=linkindex]').val();
	return { "linktype": linktype,
		"title": title,
		"body": body,
		"url": url,
		"deleted": 0,
		"img": img,
		"start": start,
		"percent": percent,
		"feedid": feedid,
		"index": index
	};
}

var printLinkPreview = function() {
	console.log(getPreviewData());
}

var updateLinkPreview = function() {
	/*
	var url = "a link";
	var type = $('[name=linktype]:checked').val(); 
	var img = 'Icons/' + $('[name=linkimage]:checked').val(); 
	var title = $('[name=title]').val(); 
	var body = $('[name=body]').val(); 
	var percent = 0;
	var start = 0;
	var feedid = 0;
	*/
	var d = getPreviewData();
	var h = feedToHtml(d.title, d.body, d.url, d.img, d.linktype, d.percent, d.start, d.feedid);
	$('#linkpreview').html(h);
}

var feedToHtml = function(title, body, url, img, type, percent, start, feedid) {
	var h = "";
        if (type == 5) { // text
                var h = '<div id="item' + feedid + '">' +
                        '<div id="itemText" start=' + start + '>' +
                                '<div id="icon"><img src="Icons/' + img + '" alt="twitter" width="55" height="55"/></div>' +
                                '<div id="itemContent">' +
                                        '<div id="itemTitle">' + title + '</div>' +
                                        '<div id="itemBody">' + body + '</div>' +
                                '</div>' +
                        '</div>' +
                        "</div>\n";
        }
        else {
                var h = '<div id="item' + feedid + '">' +
                        //'<div id="itemLink" onClick="openUrl(\'' + url + '\')" start=' + start + '>' +
                        '<div id="itemLink" start=' + start + '>' +
                                '<div id="icon"><img src="Icons/' + img + '" alt="twitter" width="55" height="55"/></div>' +
                                '<div id="itemContent">' +
                                        '<div id="itemTitle"> ' + title + '</div>' +
                                        '<div id="itemBody">' + body + '</div>' +
                                '</div>' +
                        '</div>' +
                        "</div>\n";
        }
	return h;
}


var enableLogin = function(userid, username) {
	if (userid) {
		$("#loginbar").hide();
		$("#logoutbar").show();
		$("#topusername").html(username);
		loggedin = true;
	}
	else {
		$("#loginbar").show();
		$("#logoutbar").hide();
		$("#topusername").html("");
		loggedin = false;
	}
}

var loadMovie = function(url) {
	console.log("loadMovie " + url);
	//popcorn = Popcorn.smart('#youtube', '$movie_href');
	//popcorn = Popcorn.smart('#youtube', '$movie_href');
	popcorn = Popcorn.smart('#video', url);
	popcorn.listen("error", function(e) {
		console.log("popcorn error " + e);
	});
	popcorn.listen("durationchange", function() {
		console.log("popcorn duration " + popcorn.duration());
		var duration = popcorn.duration();
		clearFeed();
		var data = feeddata;
		$.each(data.timefeed, function(i, item) {
			var p = (item.start / duration) * 100;	
			//console.log(i + " " + item.title + " " + item.start + " / " + duration);
			addTimeLineEvent(i, item.feedid, item.title, item.body, item.url, p); 
			//addFeedEvent(item.title, item.body, item.url, item.img, item.linktype, p, item.start, item.feedid);
			//addFeedEvent(item.title, item.body, p); 
		});
		//hideFeeds();
		addTooltip();
	});
}

var deleteTimeFeed = function() {
	var d = getPreviewData();
	console.log(d);
	$.post('api.php?do=delete_time_feed', { 
			timefeedid: d.feedid
		}, function(data) { 
		console.log("msg: " + data.msg);
		if (data.alert == "error") {
			setAlert(data.msg);
		}
		else {
			console.log("update feed" + data);
			removeTimeLineEvent(d.index);	
			addTooltip();
		}
	});
}

var updateTimeFeed = function() {
	var d = getPreviewData();
	console.log(d);
	$.post('api.php?do=update_time_feed', { 
			feedid: d.feedid, 
			start: d.start,
			end: 0,
			title: d.title,
			img: d.img,
			body: "",
			href: d.url
		}, function(data) { 
			console.log("msg: " + data.msg);
			if (data.alert == "error") {
				setAlert(data.msg);
			}
			else {
				console.log("update feed" + data);
				removeTimeLineEvent(d.index);	
				var f = feeddata.timefeed[d.index];
				f.start = d.start;
				f.img = d.img;
				f.url = d.url;	
				f.title = d.title;
				f.linktype = d.linktype;
				addTimeLineEvent(d.index, d.feedid, d.title, d.body, d.url, d.percent); 
				
				addTooltip();
			}
	});
}

var createTimeFeed = function() {
	var text = $('[name=addlinktext]').val();
	$("#timelinebar").popover('hide');
	console.log("createTimeFeed text: " + text + " movieid: " + movieid + " currentTime:" + currentTime);
	$.post('api.php?do=create_time_feed&movieid=' + movieid, { text: text, start: currentTime }, function(data) { 
		if (data.alert == "error") {
			setAlert(data.msg);
		}
		else {
			var item = data.timefeed;
			console.log(item.title);
			var length = feeddata.timefeed.length;
			var duration = popcorn.duration();
			feeddata.timefeed[length] = data.timefeed;
			var p = (item.start / duration) * 100;	
			addTimeLineEvent(length, item.feedid, item.title, item.body, item.url, p); 
			addTooltip();
		}
	}, "json")
	.success(function() { console.log("second success"); })
	.error(function(xhr, status, error) { console.log("error" + xhr.responseText + " status: " + status); })
	.complete(function() { console.log("complete"); });
}

// The higher NslowdownFactor the slower currentValue approaches targetValue
// typical values for slowdownFactor (2,4,10,20);
var weightedAverage = function(currentValue, targetValue, slowdownFactor) {
	return ((currentValue * (slowdownFactor - 1)) + targetValue) / slowdownFactor;
}

var addTooltip = function() {
	console.log("addToolTip");
        $("#timeline a").tooltip({
                animation: true,
                html: true,
                placement: "right",
                trigger: "hover",
                delay: { show: 1, hide: 100 }
        });

	$("#timeline a").click(function(e) {
		if (loggedin == false) {
			setAlert("Please sign in first");
			return;
		}	
		lastclicked = $(this);
		var idx = $(this).attr('idx');
		var data = feeddata.timefeed[idx];
		//console.log("feed event, click function" + $(this).attr('idx'));
		var h = feedToHtml(data.title, data.body, data.url, data.img, data.type, data.percent, data.start, data.feedid);
		console.log("linktype " + data.linktype);
		$('#linkpreview').html(h);
		$('[name=title]').val(data.title);
		$('[name=linkstart]').val(secondsToStr(data.start));
		$('[name=linkindex]').val(idx);
		$('[name=linkfeedid]').val(data.feedid);
		$('[name=url]').val(data.url);
		$('[name=linktype]')[data.linktype].checked = true;
		$('#linkimage1').attr('src', 'Icons/' + data.images[0]);	
		$('#linkimageradio1').val(data.images[0]);
		if (data.images[1] != "") {
			$('#linkimage2').attr('src', 'Icons/' + data.images[1]);		
			$('#linkimageradio2').val(data.images[1]);
		}
		$('#optionsRadio' + data.linktype).attr('checked', 'checked');

		console.log(data.images[0] + " " + data.images[1]);
		openEditFeed();
		e.stopPropagation();
	});

	$("#timeline").hover(
			function() {
				$("#timelinedisplay").fadeIn(100)
			},
			function() {
				$("#timelinedisplay").fadeOut(300)
			});

	var currentTimeLineX = 0;
	$("#timeline").mousemove(function(e) {
		//var posX = $(this).position().left;
		var posX = $(this).offset().left;
		var posY = $(this).position().top;
		//console.log(posX + " " + posY + " " + e.pageX);
		var offsetX = e.pageX - posX;
		var width = $(this).width();
		var duration = popcorn.duration();
		var normalized = (offsetX / width);
		var seconds = normalized * duration;
		currentTime = seconds;
		var t = secondsToTime(seconds);
		currentTimeLineX = weightedAverage(currentTimeLineX, offsetX, 10);
		$("#timelinedisplay").css("left", offsetX + "px");
		$("#timelinedisplay").html(secondsToStr(currentTime));
	});
}

var fetchEvents = function(movieid) {
	console.log("fetching events for movie" + movieid);
	$.getJSON('api.php?abc=xxx&do=movie_to_json&movieid=' + movieid, function(data) { 
		//addFeedEvent("a title", "http://www.wut.com", Math.floor((Math.random() * 100) + 1));
		//feeddata = data;
		feeddata = data;
		console.log(data.movie.name + " " + data.userid + " " + data.username);
		
		enableLogin(data.userid, data.username);
		if (data.movie && data.movie.name) {
			$("#headername").html(data.movie.name);
		}
		clearFeed();
		loadMovie(data.movie.url);
		/*
		var duration = popcorn.movie.duration;
		console.log("duration: " + duration);
		clearFeed();
		$.each(data.timefeed, function(i, item) {
			var p = (item.start / duration) * 100;	
			console.log(i + " " + item.title + " " + p);
			addFeedEvent(item.title, item.body, p); 
		});
		*/
	})
	.success(function() { console.log("second success"); })
	.error(function(xhr, status, error) { console.log("error" + xhr.responseText); })
	.complete(function() { console.log("complete"); });
}

var addTimeLineEvent = function(idx, feedid, title, body, url, percent) {
	var h = '<a href="#" id="feed' + idx + '" idx="' + idx + '" feedid="' + feedid + '" rel="tooltip" title="' + body + '" class="feed-event" style="left: ' + percent + '%;"></a>';
	console.log(h);
	$("#timeline").append(h);
}

var removeTimeLineEvent = function(idx) {
	feeddata.timefeed[idx].deleted = 1;
	$("#feed" + idx).remove();
}

var addFeedEvent = function(title, url, percent) {
	var h = "<a title='" + title + " - " + url + "' class='feed-event' style='left: " + percent + "%;'></a>";
	//console.log(h);
	$("#feeddata").append(h);
}

var clearFeed = function() {
	console.log("clearFeed");
	$("#timeline").html("");
}

var hidePopover2 = function() {
	console.log("from input type");
}

var logout = function() {
	console.log("logout");
	$.getJSON('api.php?do=logout&movieid=' + movieid, function(data) { 
		enableLogin(data.userid, "");
		setAlert(data.msg);
	})
	.success(function() { console.log("second success"); })
	.error(function(xhr, status, error) { console.log("error" + xhr.responseText); })
	.complete(function() { console.log("complete"); });
}

function getParams() {
        var idx = document.URL.indexOf('?');
        if (idx != -1) {
                var tempParams = new Object();
                var pairs = document.URL.substring(idx+1, document.URL.length).split('&');
                for (var i=0; i< pairs.length; i++) {
                        nameVal = pairs[i].split('=');
                        tempParams[nameVal[0]] = nameVal[1];
                }
                return tempParams;
        }
}

var openEditFeed = function() {
	//$("#editfeed").popover('show');
	$("#editModal").modal('show');
	$("#linktitle").focus();
}

var getTimelineTitle = function() {
	return timelineTitle;
}

$(function() {
        params = getParams();
        if (params && params["movieid"]) {
                movieid = params["movieid"];
		fetchEvents(movieid);
        }

        var onTooltipUpdate = function(tooltip, x, y) {
                console.log(tooltip);
                //console.log("yey" + x + " " + y);
        }       
	// Setup drop down menu
	$('.dropdown-toggle').dropdown();
 
  	// Fix input element click problem
	$('.dropdown input, .dropdown label').click(function(e) {
		e.stopPropagation();
	});

	$('form[name=previewform]').change(function() {
		var linktype = $('[name=linktype]:checked').val();
		var img = $('[name=linkimage]:checked').val();
		//console.log("linktype: " + linktype + " img: " + img);
		//console.log("here" + $('[name=linktype]:checked').val());
		updateLinkPreview();
	});

	$('form[name=loginform]').submit(function() {
		console.log("loginform submit");
		console.log("username" + $('[name=username]').val());
		$.post('api.php?do=login',{
			username: $('[name=username]').val(), 
			password: $('[name=password]').val() }, 
			function(data) {
				setAlert(data.alert + " " + data.msg);
				console.log(data.alert + " " + data.msg);
				enableLogin(data.userid, data.username);
				/*
				if (data.success) {
					console.log("success");
				}
				else {
					console.log("fail");
				}
				*/
			}, 'json');
		return false;
	});

        $("#timeline a").tooltip({
                track: true,
                delay: 0,
                showURL: false,
                fixPNG: false,
                showBody: " - ",
                extraClass: "pretty fancy",
                top: -15,
                onUpdate: onTooltipUpdate,
                left: 5
        });

	$(".container").click(function(e) {
		$("#timelinebar").popover('hide');
	});

	$("#timeline").click(function(e) {
		if (loggedin == false) {
			setAlert("Please sign in first");
			return;
		}	
		//var posX = $(this).position().left;
		var posX = $(this).offset().left;
		var posY = $(this).position().top;
		var offsetX = e.pageX - posX;
		var width = $(this).width();
		var duration = popcorn.duration();
		if (duration == 0) {
			console.log("move doesnt have duration yet");
			return;
		}
		var normalized = (offsetX / width);
		var seconds = normalized * duration;
		currentTime = seconds;
		var t = secondsToTime(seconds);
		$("#timelinebar").css("left", offsetX + "px");
		if (t.h > 0) {
			timelineTitle = t.h + "h" + t.m + "m" + t.s + "s";
		}
		else if (t.m > 0) {
			timelineTitle = t.m + "m" + t.s + "s";
		}
		else {
			timelineTitle = t.s + "s";
		}
		e.stopPropagation();
		$("#timelinebar").popover('show');
		$("#addlink").focus();
	});

	$("#timelinebar").popover({placement: "bottom", live:true, 
			title: getTimelineTitle, 
			content: '<input name="addlinktext" id="addlink" type="text" placeholder="paste link or type comment" onSubmit="hidePopover2(); return false;"/><button class="btn" onclick="createTimeFeed();">Save</button>', 
			html:true
	});
});

</script>

	<div class="navbar navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container">
				<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</a>
 
				<a class="brand" id="headername">linklib.org</a>

				<div class="nav-collapse">
					<ul class="nav pull-right" id="loginbar">
						<li><a href="/users/sign_up">Sign Up</a></li>
						<li class="divider-vertical"></li>
						<li class="dropdown">
							<a class="dropdown-toggle" href="#" data-toggle="dropdown">Sign In <strong class="caret"></strong></a>
							<div class="dropdown-menu" style="padding: 15px; padding-bottom: 0px;">
								<form action="" method="post" accept-charset="UTF-8" name="loginform">
									<input id="username" style="margin-bottom: 15px;" type="text" name="username" size="30" />
									<input id="password" style="margin-bottom: 15px;" type="password" name="password" size="30" />
									<input class="btn btn-primary" style="clear: left; width: 100%; height: 32px; font-size: 13px;" type="submit" name="commit" value="Sign In" />
								</form>
							</div>
						</li>
					</ul>
					<ul class="nav pull-right" id="logoutbar">
						<li id="topusername">username</li>
						<li class="divider-vertical"></li>
						<li><button class="btn" onclick="logout();">Logout</button></li>
					</ul>
				</div>
			</div>
		</div>
	</div>

	<div class="container" style="position:absolute; left:0; width:100%; height:800px;background-color:#ffFFff">
		<!-- <button class="btn" onclick="hidePopover(44);">Save</button> -->
		<!--
    		<div class="alert" id="apialert">
    			<button type="button" class="close" data-dismiss="alert"></button>
    			<strong>Warning!</strong> Best check yo self, you're not looking too good.
    		</div>
		-->
		<div id="videodiv" class="videodiv"> 
			<div id="video" style="position:relative; padding-top:50px;width:100%;height:480px;background-color:#FFFFFF"></div>
			<div id="timelinecontainer" style="position:relative; width:70%; margin-left:auto; margin-right:auto;margin-top:10px">
				<div id="timeline"></div>
				<div id="timelinebar" style="position:absolute; height:20px;left:100px;width:10px;background-color:#fff0ff; opacity:0.1;"></div>
				<div id="timelinedisplay" style="position:absolute; height:20px;top:20px;left:100px;width:100px;background-color:#ffffff;">11:11:22</div>
			</div>
		</div>
		<div id="apialert"></div>
	</div>

	<div id="editModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			<h3 id="editModalLabel">Edit Feed</h3>
		</div>
		<div class="modal-body">
			<p>Link preview</p>
			<p>
			<div id="linkpreview">
                        	<div id="itemText">
                                	<div id="icon">
						<img src="Icons/twitter.svg" alt="twitter" width="55" height="55"/>
					</div>
                                	<div id="itemContent">
                                       		<div id="itemTitle">Title</div>
						<div id="itemBody">body</div>
					</div>
                        	</div>
			</div>
			</p>
			<form name="previewform">
				<input type="hidden" name="linkfeedid" value="123">
				<input type="hidden" name="linkindex" value="123">
				<label class="control-label" for="linktitle">Title
					<input class="input-xlarge" name="title" id="linktitle" type="text" value="title"><span class="help-inline">title</span>
				</label>
				<label class="control-label" for="linkurl">Url
					<input class="input-xlarge" name="url" id="linkurl" type="text" value="url"><span class="help-inline">url</span>
				</label>
				<label class="control-label" for="linkstart">HH:MM:SS
					<input class="input-small" name="linkstart" id="linkstart" type="text" value="0">
				</label>
				<p>Link Type</p>
				<label class="radio">
					<input type="radio" name="linktype" id="optionsRadios0" value="0" checked> Web Page
				</label>
				<label class="radio">
					<input type="radio" name="linktype" id="optionsRadios5" value="5"> Text 
				</label>
				<label class="radio">
					<input type="radio" name="linktype" id="optionsRadios3" value="3"> Video 
				</label>
			<p>Choose Image</p>
			<label class="radio inline">
				<input type="radio" name="linkimage" id="linkimageradio1" value="twitter.svg" checked> 
					<img id="linkimage1" src="Icons/twitter.svg" width="55" height="55" style="background-color:#000" /> 
			</label>
			<label class="radio inline">
				<input type="radio" name="linkimage" id="linkimageradio2" value="facebook.svg">
					<img id="linkimage2" src="Icons/facebook.svg" width="55" height="55" style="background-color:#000" /> 
			</label>
			</form>
			<!--
    			<div class="btn-group">
    				<button class="btn">1</button>
				<button class="btn">2</button>
				<button class="btn">3</button>
			</div>
			-->
		</div>
		<div class="modal-footer">
			<button class="btn pull-left" data-dismiss="modal" onClick="deleteTimeFeed()">Delete</button>
			<button class="btn" data-dismiss="modal">Close</button>
			<button class="btn btn-primary" data-dismiss="modal" onClick="updateTimeFeed()">Save changes</button>
		</div>
	</div>

         <div id="myPopover" class="popover bottom">
            <div class="arrow"></div>
            <h3 class="popover-title">Popover bottom</h3>
            <div class="popover-content">
              <p>Sed posuere consectetur est at lobortis. Aenean eu leo quam. Pellentesque ornare sem lacinia quam venenatis vestibulum.</p>
            </div>
          </div>


	<a href="#" id="element2" rel="popover" title="A Title" data-content="And here's some amazing content. It's very engaging. right?">Yo</a>
		<!--
		<div class="bs-docs-example" style="padding-bottom: 24px;">
			<a href="#" id="element2" class="btn btn-large btn-danger" rel="popover" title="A Title" data-content="And here's some amazing content. It's very engaging. right?">Click to toggle popover</a>
		</div>
	-->
</body>
</html>
