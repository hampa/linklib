<!DOCTYPE html>
<html lang="en">
<head>
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/movieline.css" rel="stylesheet"/>
</head>
<body>
<script src="http://code.jquery.com/jquery-latest.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="http://popcornjs.org/code/dist/popcorn-complete.js"></script>
<script src="lib/socket.io/socket.io.js"></script>
<script>

var socket = null;
var json = null;
var userid = 0
var username = "";
var movieid = 0;
var popcorn = null;
var serverLocation = 'http://linkontrol.toribash.com:1337';	
var streamId = "someStreamId";
var mouseMoveTime = 0;

$(document).ajaxError(function(e, xhr, settings, exception) {
	console.log('error in: ' + settings.url + ' \\n'+'error:\\n' + exception);
});

var setAlert = function(message) {
	$('#apialert').html('<div class="alert"><a class="close" data-dismiss="alert">x</a><span>'+message+'</span></div>');
	$("#apialert").show();
}

var addQrCode = function(id) {
	$("#qrcodediv").html(
			'<img id="qrcode" src="http://chart.apis.google.com/chart?chs=128x128&cht=qr&chld=L|0&chl=http%3A%2F%2Fwww.linkontrol.com%2Fremote.php%3Fid%3D' 
			+ id + '" alt="Get links in your mobile">');  // widthHeight="64" widthHeight="64"/>');
}

var getTimestamp = function() {
	return +new Date();
}

var enableLogin = function(userid, username) {
	if (userid) {
		$("#loginbar").hide();
		$("#logoutbar").show();
		$("#topusername").html(username);
	}
	else {
		$("#loginbar").show();
		$("#logoutbar").hide();
		$("#topusername").html("");
	}
}

var loadMovie = function(url) {
	console.log("loadMovie " + url);
	popcorn = Popcorn.smart('#video', url);
	popcorn.listen("error", function(e) {
		console.log("popcorn error " + e);
	});
	popcorn.listen("durationchange", function() {
		console.log("popcorn duration " + popcorn.duration());
		var duration = popcorn.duration();
		clearFeed();
		var data = myData;
		$.each(data.timefeed, function(i, item) {
			var p = (item.start / duration) * 100;	
			//console.log(i + " " + item.title + " " + item.start + " / " + duration);
			addFeedEvent(item.title, item.body, item.url, p); 
		});
		addTooltip();
	});
}

var addTooltip = function() {
	//$("#feeddata a").tooltip();
        $("#feeddata a").tooltip({
                animation: true,
                html: true,
                placement: "top",
                //title: "hejsan",
                trigger: "hover",
                delay: { show: 1, hide: 100 }
        });
}

var hidePopover = function(x) {
	console.log("do it2" + x);
	$("#kuk").popover('hide');
	$.post('api.php?do=add_time_feed&movieid=' + movieid, { title: $('[name=url]').val() }, function(data) { 
		myData = data;
		console.log(data.alert + " " + data.userid + " " + data.username + " " + data.timefeed.title);
		//if (data.alert == "error") {
			setAlert(data.msg);
		//}
		//addFeedEvent("a title", "http://www.wut.com", Math.floor((Math.random() * 100) + 1));
  		//$('.result').html(data);
	}, "json")
	.success(function() { console.log("second success"); })
	.error(function(xhr, status, error) { console.log("error" + xhr.responseText + " status: " + status); })
	.complete(function() { console.log("complete"); });

}

var myData;
var fetchEvents = function(movieid, sessionid) {
	console.log("fetching events for movie" + movieid);
	$.getJSON('api.php?abc=xxx&do=movie_to_json&movieid=' + movieid + '&sessionid=' + sessionid, function(data) { 
		//addFeedEvent("a title", "http://www.wut.com", Math.floor((Math.random() * 100) + 1));
		myData = data;
		console.log(data.movie.name + " " + data.userid + " " + data.username);
		
		enableLogin(data.userid, data.username);
		if (data.movie && data.movie.name) {
			$("#moviename").html(data.movie.name);
		}
		loadMovie(data.movie.url);
		streamId = sessionid;
		addQrCode(sessionid);
		connect();
	})
	.success(function() { console.log("second success"); })
	.error(function(xhr, status, error) { console.log("error" + xhr.responseText); })
	.complete(function() { console.log("complete"); });
}

var addFeedEvent = function(title, body, url, percent) {
	//var h = '<a href="#" id="bajs" rel="tooltip" title="' + title + " - " + url + '" class="feed-event" style="left: ' + percent + '%;"></a>';
	var h = '<a href="#" id="bajs" rel="tooltip" title="' + body + '" class="feed-event" style="left: ' + percent + '%;"></a>';
	$("#feeddata").append(h);
}

var clearFeed = function() {
	console.log("clearFeed");
	$("#feeddata").html("");
}

var hidePopover2 = function() {
	console.log("from input type");
	//$("#kuk").popover('hide');
}

var logout = function() {
	console.log("logout");
	$.getJSON('api.php?do=logout&movieid=' + movieid, function(data) { 
		enableLogin(data.userid, "");
		setAlert(data.msg);
	})
	.success(function() { console.log("second success"); })
	.error(function(xhr, status, error) { console.log("error" + xhr.responseText); })
	.complete(function() { console.log("complete"); });
}

function getParams() {
        var idx = document.URL.indexOf('?');
        if (idx != -1) {
                var tempParams = new Object();
                var pairs = document.URL.substring(idx+1, document.URL.length).split('&');
                for (var i=0; i< pairs.length; i++) {
                        nameVal = pairs[i].split('=');
                        tempParams[nameVal[0]] = nameVal[1];
                }
                return tempParams;
        }
}

var handleGetTime = function(data) {
	data.time = popcorn.currentTime();
	emit("time", data);
}

function emit(command, data) {
	if (!data) {
		data = {};
	}
	data.streamId = streamId;
	socket.emit(command, data);
}

var connect = function() {
	console.log("connecting");
	socket = io.connect(serverLocation);
	socket.emit("join", {'streamId':streamId});
	socket.on('getTime', handleGetTime);
}

$(function() {
	mouseMoveTime = getTimestamp();
        params = getParams();
	console.log("here");
        if (params) {
		if (params["movieid"]) {
                	movieid = params["movieid"];
			sessionid = params['id'];
			fetchEvents(movieid, sessionid);
		}
        }

	// Setup drop down menu
	$('.dropdown-toggle').dropdown();
 
  	// Fix input element click problem
	$('.dropdown input, .dropdown label').click(function(e) {
		e.stopPropagation();
	});

	$('form[name=loginform]').submit(function() {
		console.log("loginform submit");
		console.log("username" + $('[name=username]').val());
		$.post('api.php?do=login',{
			username: $('[name=username]').val(), 
			password: $('[name=password]').val() }, 
			function(data) {
				setAlert(data.alert + " " + data.msg);
				console.log(data.alert + " " + data.msg);
				enableLogin(data.userid, data.username);
				/*
				if (data.success) {
					console.log("success");
				}
				else {
					console.log("fail");
				}
				*/
			}, 'json');
		return false;
	});

        setInterval(function () {
		if (socket == null) {
			return;
		}
                var data = {};
                if (!data.time) {
                        data.time = popcorn.currentTime();
                }
                if (popcorn.paused()) {
                        emit("onPause", data);
                }
                else {
                        emit("onPlay", data);
                }
		var t = getTimestamp();
		var diff = t - mouseMoveTime;
		if (diff > 8000) { 
			$("#qrcode").fadeOut('slow', function() {
				//console.log("fade done " + $('#qrcode').css("style"));
			});
		}
		//console.log(t - mouseMoveTime);
        }, 700);

	$("#qrcode2").hover(function() {
		// hover in
		$(this).parent().parent().css("z-index", 1);
		$(this).animate({
			height: "128",
			width: "128",
			left: "-=50",
			top: "-=50"
		}, "fast");
		}, function() {
		// hover out
		$(this).parent().parent().css("z-index", 0);
		$(this).animate({
			height: "64",
			width: "64",
			left: "+=50",
			top: "+=50"
		}, "fast");
	});

	$("#timeline").mousemove(function(e) {
		mouseMoveTime = getTimestamp();
		$("#qrcode").fadeIn('fast', function() {
			console.log("fade in done");
		});
	});

});
</script>
	<div class="navbar navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container">
				<a class="brand" id="moviename">linklib.org</a>
				<!--
				<div class="nav-collapse">
					<ul class="nav pull-right" id="loginbar">
						<li><a href="/users/sign_up">Sign Up</a></li>
						<li class="divider-vertical"></li>
						<li class="dropdown">
							<a class="dropdown-toggle" href="#" data-toggle="dropdown">Sign In <strong class="caret"></strong></a>
							<div class="dropdown-menu" style="padding: 15px; padding-bottom: 0px;">
								<form action="" method="post" accept-charset="UTF-8" name="loginform">
								<input id="username" style="margin-bottom: 15px;" type="text" name="username" size="30" />
								<input id="password" style="margin-bottom: 15px;" type="password" name="password" size="30" />
								<input class="btn btn-primary" style="clear: left; width: 100%; height: 32px; font-size: 13px;" type="submit" name="commit" value="Sign In" />
								</form>
							</div>
						</li>
					</ul>
					<ul class="nav pull-right" id="logoutbar">
						<li><a href="#" id="topusername">username</a></li>
						<li class="divider-vertical"></li>
						<li><button class="btn" onclick="logout();">Logout</button></li>
					</ul>
				</div>
				-->
			</div>
		</div>
	</div>

	<div class="container" style="height:800px;background-color:#000000;width:100%;height:1000px">
		<div id="videodiv" class="videodiv">
			<div id="video" style="position:absolute;top:43px;width:100%;height:600px;background-color:#000000"></div>
		</div>
		<div id="timeline">
			<div id="feeddata">
				<!--
				<a href="#" rel="tooltip" title="hej - <strong>was</strong>" class="feed-event" style="left: 50%;"></a>
				<a href="#" rel="tooltip" title="hej - <strong>was</strong>" class="feed-event" style="left: 10%;"></a>
				-->
			</div>
		</div>
		<div id="apialert"></div>
		<div id="qrcodediv" style="position:absolute;top:695px;right:0px;">
			<!--
			<img id="qrcode" src="http://chart.apis.google.com/chart?chs=64x64&cht=qr&chld=L|0&chl=http%3A%2F%2Fwww.linkontrol.com%2Fipad.html%3Fid%3D_IDCODE_" 
				alt="Get links in your mobile" widthHeight="64" widthHeight="64"/>
			-->
		</div>
	</div>
</body>
</html>
